!function(){var a={serialize:function(a,c,d){d=d||{};var e=d.encode||b,f=[a+"="+e(c)];if(null!=d.maxAge){var g=d.maxAge-0;if(isNaN(g))throw new Error("maxAge should be a Number");f.push("Max-Age="+g)}return d.domain&&f.push("Domain="+d.domain),d.path&&f.push("Path="+d.path),d.expires&&f.push("Expires="+d.expires.toUTCString()),d.httpOnly&&f.push("HttpOnly"),d.secure&&f.push("Secure"),f.join("; ")},parse:function(a,b){b=b||{};var d={},e=a.split(/; */),f=b.decode||c;return e.forEach(function(a){var b=a.indexOf("=");if(!(0>b)){var c=a.substr(0,b).trim(),e=a.substr(++b,a.length).trim();if('"'==e[0]&&(e=e.slice(1,-1)),void 0==d[c])try{d[c]=f(e)}catch(g){d[c]=e}}}),d}},b=encodeURIComponent,c=decodeURIComponent;"undefined"!=typeof module&&module.exports?module.exports=a:"function"==typeof define&&define.amd?define(function(){return a}):window.cookiejs=a}(),function(a){function b(b,d){return function(e){a.localStorage||console.error("Local storage must be supported for instant login.");var f=this,g={domain:location.hostname.split(".").slice(-2).join("."),path:"/",secure:"https:"===location.protocol,expires:new Date(Date.now()+6048e5)},h=/ref=(\w+)/.exec(a.location.search),i=d.parse(document.cookie).webmakerReferral;h&&(h=h[1]),e=e||{},e.paths=e.paths||{},f.emitter=new b,f.host=e.host||"",f.paths=e.paths||{},f.paths.authenticate=e.paths.authenticate||"/authenticate",f.paths.create=e.paths.create||"/create",f.paths.verify=e.paths.verify||"/verify",f.paths.logout=e.paths.logout||"/logout",f.paths.checkUsername=e.paths.checkUsername||"/check-username",f.urls={authenticate:f.host+f.paths.authenticate,create:f.host+f.paths.create,verify:f.host+f.paths.verify,logout:f.host+f.paths.logout,checkUsername:f.host+f.paths.checkUsername},f.audience=e.audience||a.location.protocol+"//"+a.location.host,f.prefix=e.prefix||"webmaker-",f.timeout=e.timeout||10,f.localStorageKey=f.prefix+"login",f.csrfToken=e.csrfToken,f.withCredentials=e.withCredentials===!1?!1:!0,h&&i!==h&&(document.cookie=d.serialize("webmakerReferral",h,g)),f.handleNewUserUI=e.handleNewUserUI===!1?!1:!0,f.modal={},f.modal.element=document.getElementById("webmaker-login-new-user"),f.modal.dismissSelector="[data-dismiss]",f.modal.createSelector=".create-user",f.modal.createBtnOnClick=function(){},f.modal.checkUsernameOnChange=function(){var a=f.modal.element.querySelector(".username-taken-error"),b=f.modal.element.querySelector(".username-invalid-error"),c=f.modal.element.querySelector(".username-required-error"),d=f.modal.element.querySelector(".username-group"),e=this.value;return e?void f.checkUsername(e,function(e,f){e&&"Username taken"===f?(d.classList.add("has-error"),d.classList.remove("has-success"),a.classList.remove("hidden"),c.classList.add("hidden"),b.classList.add("hidden")):e&&"Username invalid"===f?(d.classList.add("has-error"),d.classList.remove("has-success"),b.classList.remove("hidden"),a.classList.add("hidden"),c.classList.add("hidden")):(d.classList.remove("has-error"),d.classList.add("has-success"),a.classList.add("hidden"),c.classList.add("hidden"),b.classList.add("hidden"))}):(d.classList.remove("has-success"),d.classList.add("has-error"),a.classList.add("hidden"),c.classList.remove("hidden"),void b.classList.add("hidden"))},f.modal.setup=function(a){var b=f.modal.element.querySelector(f.modal.createSelector),c=f.modal.element.querySelectorAll(f.modal.dismissSelector),d=f.modal.element.querySelector(".username-group"),e=f.modal.element.querySelector(".agree-group"),g=f.modal.element.querySelector(".username-taken-error"),h=f.modal.element.querySelector(".username-required-error"),j=f.modal.element.querySelector(".username-invalid-error"),k=f.modal.element.querySelector(".agree-error"),l=f.modal.element.querySelector('[name="username"]'),m=f.modal.element.querySelector('[name="agreeToTerms"]'),n=f.modal.element.querySelector('[name="mailingList"]');b.removeEventListener("click",f.modal.createBtnOnClick,!1),l.addEventListener("change",f.modal.checkUsernameOnChange,!1),f.modal.createBtnOnClick=function(){var b=!1;m.checked||(e.classList.add("has-error"),k.classList.remove("hidden"),b=!0),l.value||(d.classList.remove("has-success"),d.classList.add("has-error"),g.classList.add("hidden"),h.classList.remove("hidden"),j.classList.add("hidden"),b=!0),b||f.checkUsername(l.value,function(b,c){b&&"Username taken"===c?(d.classList.add("has-error"),d.classList.remove("has-success"),g.classList.remove("hidden"),h.classList.add("hidden"),j.classList.add("hidden")):b&&"Username invalid"===c?(d.classList.add("has-error"),d.classList.remove("has-success"),j.classList.remove("hidden"),g.classList.add("hidden"),h.classList.add("hidden")):(f.createUser({assertion:a,user:{username:l.value,mailingList:n.checked,referrer:i}}),g.classList.add("hidden"),h.classList.add("hidden"),j.classList.add("hidden"),k.classList.add("hidden"),d.classList.remove("has-error"),d.classList.remove("has-success"),e.classList.remove("has-error"),f.modal.close())})};for(var o=0;o<c.length;o++)c[o].removeEventListener("click",f.modal.close,!1),c[o].addEventListener("click",f.modal.close,!1);b.addEventListener("click",f.modal.createBtnOnClick,!1)},f.modal.open=function(){f.modal.element.classList.add("in"),f.modal.element.style.display="block",f.modal.element.setAttribute("aria-hidden",!1)},f.modal.close=function(){f.modal.element.classList.remove("in"),f.modal.element.style.display="none",f.modal.element.setAttribute("aria-hidden",!0)},f.on=function(a,b){f.emitter.addListener(a,b)},f.off=function(a,b){f.emitter.removeListener(a,b)},f.checkUsername=function(a,b){if(!c.test(a))return b(!0,"Username invalid");var d=new XMLHttpRequest,e=JSON.stringify({username:a});d.open("POST",f.urls.checkUsername,!0),d.withCredentials=f.withCredentials,d.setRequestHeader("Content-type","application/json"),d.setRequestHeader("X-CSRF-Token",f.csrfToken),d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var a=JSON.parse(d.responseText);a.exists?b(!0,"Username taken"):b(!1,"Username not taken")}else 4===d.readyState&&d.status&&(d.status>=400||d.status<200)?(f.emitter.emitEvent("error",[d.responseText]),b(!1,"Error checking username")):4===d.readyState&&(f.emitter.emitEvent("error",["Looks like "+f.urls.checkUsername+" is not responding..."]),b(!1,"Error checking username"))},d.send(e)},f.createUser=function(a){var b=new XMLHttpRequest,c=JSON.stringify({assertion:a.assertion,audience:f.audience,user:a.user});b.open("POST",f.urls.create,!0),b.withCredentials=f.withCredentials,b.setRequestHeader("Content-type","application/json"),b.setRequestHeader("X-CSRF-Token",f.csrfToken),b.onreadystatechange=function(){if(4===b.readyState&&200===b.status){var a=JSON.parse(b.responseText);a.user?(f.storage.set(a.user),f.emitter.emitEvent("login",[a.user,"user created"])):f.emitter.emitEvent("error",[b.responseText])}else 4===b.readyState&&b.status&&(b.status>=400||b.status<200)?f.emitter.emitEvent("error",[b.responseText]):4===b.readyState&&f.emitter.emitEvent("error",["Looks like "+f.urls.create+" is not responding..."])},b.send(c)},f.verify=function(){f.storage.get()&&f.emitter.emitEvent("login",[f.storage.get(),"restored"]);var a=f.storage.get("email"),b=new XMLHttpRequest;b.open("POST",f.urls.verify,!0),b.withCredentials=f.withCredentials,b.setRequestHeader("Content-type","application/json"),b.setRequestHeader("X-CSRF-Token",f.csrfToken),b.onreadystatechange=function(){if(4===b.readyState&&200===b.status){var c=JSON.parse(b.responseText);a&&c.email===a?(f.emitter.emitEvent("login",[c.user]),f.storage.set(c.user)):c.user?(f.emitter.emitEvent("login",[c.user,"email mismatch"]),f.storage.set(c.user)):f.logout()}else 4===b.readyState&&b.status&&(b.status>=400||b.status<200)?f.emitter.emitEvent("error",[b.responseText]):4===b.readyState&&f.emitter.emitEvent("error",["Looks like "+f.urls.verify+" is not responding..."])},b.send()},f.login=function(){a.navigator.id||console.error("No persona found. Did you include include.js?"),a.removeEventListener("focus",f.verify,!1),a.navigator.id.get(function(b){if(!b)return void f.emitter.emitEvent("error",["No assertion was received"]);var c=new XMLHttpRequest,d=JSON.stringify({audience:f.audience,assertion:b});if(f.timeout)var e=setTimeout(function(){f.emitter.emitEvent("error",["The request for a token timed out after "+f.timeout+" seconds"])},1e3*f.timeout);c.open("POST",f.urls.authenticate,!0),c.withCredentials=f.withCredentials,c.setRequestHeader("Content-type","application/json"),c.setRequestHeader("X-CSRF-Token",f.csrfToken),c.onreadystatechange=function(){if(f.timeout&&e&&clearTimeout(e),4===c.readyState&&200===c.status){var d=JSON.parse(c.responseText);d.error&&f.emitter.emitEvent("error",[d.error]),d.user&&(f.storage.set(d.user),f.emitter.emitEvent("login",[d.user]),a.addEventListener("focus",f.verify,!1)),d.email&&!d.user&&(f.emitter.emitEvent("newuser",[b,d.email]),f.handleNewUserUI&&(f.modal.setup(b,d.email),f.modal.open())),d.err&&f.emitter.emitEvent("error",[d.err])}else 4===c.readyState&&c.status&&(c.status>=400||c.status<200)?f.emitter.emitEvent("error",[c.responseText]):4===c.readyState&&f.emitter.emitEvent("error",["Looks like "+f.urls.authenticate+" is not responding..."])},c.send(d)},{backgroundColor:"#E3EAEE",privacyPolicy:"https://webmaker.org/privacy",siteLogo:"https://stuff.webmaker.org/persona-assets/logo-webmaker.png",siteName:"Mozilla Webmaker",termsOfService:"https://webmaker.org/terms"})},f.logout=function(){a.removeEventListener("focus",f.verify,!1);var b=new XMLHttpRequest;b.open("POST",f.urls.logout,!0),b.withCredentials=f.withCredentials,b.setRequestHeader("X-CSRF-Token",f.csrfToken),b.onreadystatechange=function(){4===b.readyState&&200===b.status?(f.emitter.emitEvent("logout"),f.storage.clear(),a.addEventListener("focus",f.verify,!1)):4===b.readyState&&b.status&&(b.status>=400||b.status<200)?f.emitter.emitEvent("error",[b.responseText]):4===b.readyState&&f.emitter.emitEvent("error",["Looks like "+f.urls.logout+" is not responding..."])},b.send(null)},f.storage={get:function(a){var b=JSON.parse(localStorage.getItem(f.localStorageKey));if(b)return a?b[a]:b},set:function(a){var b=JSON.parse(localStorage.getItem(f.localStorageKey))||{};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);localStorage.setItem(f.localStorageKey,JSON.stringify(b))},clear:function(){delete localStorage[f.localStorageKey]}}}}var c=/^[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\-\_]{1,20}$/;"function"==typeof define&&define.amd?define(["eventEmitter/EventEmitter","cookie-js/cookie"],b):a.WebmakerAuthClient=b(a.EventEmitter,a.cookiejs)}(window);